import { useState, useMemo } from 'react';
import { format } from 'date-fns';
import { AppLayout } from '@/components/AppLayout';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Switch } from '@/components/ui/switch';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Calendar } from '@/components/ui/calendar';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter,
} from '@/components/ui/dialog';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { useMembers } from '@/hooks/useMembers';
import { useTransactions } from '@/hooks/useTransactions';
import { useProfile } from '@/hooks/useProfile';
import { useFreeTierLimits } from '@/hooks/useFreeTierLimits';
import { formatCurrency, formatDate, toDateInputValue, calculateExpiryDate, getDaysUntilExpiry } from '@/lib/format';
import { generateMemberInvoice } from '@/lib/pdf-generator';
import { shareInvoiceViaWhatsApp, createInvoicePDF } from '@/lib/whatsapp-pdf-share';
import { Plus, Phone, Loader2, CreditCard, AlertTriangle, FileText, MessageCircle, Trash2, Search, Filter, X, Calendar as CalendarIcon, RefreshCw, History, Send, Crown, Upload, Share2, Pencil, UserPlus } from 'lucide-react';
import { toast } from 'sonner';
import type { Database } from '@/integrations/supabase/types';
import { UpgradePlanModal } from '@/components/UpgradePlanModal';
import { MemberImportModal } from '@/components/MemberImportModal';
import { MemberRenewalModal } from '@/components/MemberRenewalModal';
import { TransactionHistoryModal } from '@/components/TransactionHistoryModal';
import { cn } from '@/lib/utils';

type PlanType = Database['public']['Enums']['plan_type'];
type MemberStatus = Database['public']['Enums']['member_status'];

export default function Members() {
  const { members, isLoading, addMember, updateMember, deleteMember } = useMembers();
  const { addTransaction, getMemberTransactions } = useTransactions();
  const { profile, incrementInvoiceNumber, getNextInvoiceNumber } = useProfile();
  const freeTierLimits = useFreeTierLimits();
  const [isUpgradeOpen, setIsUpgradeOpen] = useState(false);
  const [upgradeLimitType, setUpgradeLimitType] = useState<'members' | 'invoices' | 'receipts'>('members');
  const [isAddOpen, setIsAddOpen] = useState(false);
  const [isPaymentOpen, setIsPaymentOpen] = useState(false);
  const [isInvoiceDialogOpen, setIsInvoiceDialogOpen] = useState(false);
  const [isSmartRenewalOpen, setIsSmartRenewalOpen] = useState(false);
  const [isHistoryOpen, setIsHistoryOpen] = useState(false);
  const [isBulkReminderOpen, setIsBulkReminderOpen] = useState(false);
  const [isImportOpen, setIsImportOpen] = useState(false);
  const [isEditOpen, setIsEditOpen] = useState(false);
  const [deleteId, setDeleteId] = useState<string | null>(null);
  const [lastPaymentInfo, setLastPaymentInfo] = useState<{ memberName: string; amount: number; phone: string } | null>(null);
  const [selectedMember, setSelectedMember] = useState<typeof members[0] | null>(null);
  const [editFormData, setEditFormData] = useState({
    name: '',
    phone: '',
    plan_type: '3-time' as PlanType,
    monthly_fee: '',
    status: 'active' as MemberStatus,
    joining_date: null as Date | null,
    plan_expiry_date: null as Date | null,
  });
  const [paymentAmount, setPaymentAmount] = useState('');
  const [paymentDate, setPaymentDate] = useState<Date | null>(new Date());
  const [showPaymentCalendar, setShowPaymentCalendar] = useState(false);
  const [showJoiningCalendar, setShowJoiningCalendar] = useState(false);
  const [showExpiryCalendar, setShowExpiryCalendar] = useState(false);

  // Search and filter state
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState<MemberStatus | 'all'>('all');
  const [planFilter, setPlanFilter] = useState<PlanType | 'all'>('all');
  const [showFilters, setShowFilters] = useState(false);

  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    plan_type: '3-time' as PlanType,
    monthly_fee: '',
    joining_date: toDateInputValue(new Date()),
    isPaid: true,
  });

  // Filtered members
  const filteredMembers = useMemo(() => {
    return members.filter((member) => {
      const matchesSearch = searchQuery === '' ||
        member.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        member.phone.includes(searchQuery);
      const matchesStatus = statusFilter === 'all' || member.status === statusFilter;
      const matchesPlan = planFilter === 'all' || member.plan_type === planFilter;
      return matchesSearch && matchesStatus && matchesPlan;
    });
  }, [members, searchQuery, statusFilter, planFilter]);

  // Members with outstanding balance for bulk reminder
  const unpaidMembers = useMemo(() => {
    return members.filter((m) => Number(m.balance) > 0);
  }, [members]);

  const hasActiveFilters = statusFilter !== 'all' || planFilter !== 'all';

  const clearFilters = () => {
    setStatusFilter('all');
    setPlanFilter('all');
    setSearchQuery('');
  };

  const handleAddMember = async (e: React.FormEvent) => {
    e.preventDefault();

    // Check free tier limit
    if (!freeTierLimits.canAddMember) {
      setUpgradeLimitType('members');
      setIsUpgradeOpen(true);
      return;
    }

    const joiningDate = new Date(formData.joining_date);
    const expiryDate = calculateExpiryDate(joiningDate);
    const monthlyFee = Number(formData.monthly_fee);
    const balance = formData.isPaid ? 0 : monthlyFee;

    const newMember = await addMember.mutateAsync({
      name: formData.name.trim(),
      phone: formData.phone.trim(),
      plan_type: formData.plan_type,
      monthly_fee: monthlyFee,
      balance: balance,
      status: 'active',
      joining_date: joiningDate.toISOString(),
      plan_expiry_date: expiryDate.toISOString(),
    });

    if (formData.isPaid && newMember) {
      await addTransaction.mutateAsync({
        member_id: newMember.id,
        amount: monthlyFee,
        type: 'payment',
        notes: 'Initial payment on signup',
      });

      setLastPaymentInfo({
        memberName: formData.name.trim(),
        amount: monthlyFee,
        phone: formData.phone.trim(),
      });
      setIsInvoiceDialogOpen(true);
    }

    setFormData({
      name: '',
      phone: '',
      plan_type: '3-time',
      monthly_fee: '',
      joining_date: toDateInputValue(new Date()),
      isPaid: true,
    });
    setIsAddOpen(false);
  };

  const handlePayment = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!selectedMember) return;

    const amount = Number(paymentAmount);
    if (amount <= 0) return;

    await addTransaction.mutateAsync({
      member_id: selectedMember.id,
      amount,
      type: 'payment',
      date: paymentDate ? paymentDate.toISOString() : new Date().toISOString(),
    });

    const newBalance = Number(selectedMember.balance) - amount;
    await updateMember.mutateAsync({
      id: selectedMember.id,
      balance: newBalance,
    });

    setLastPaymentInfo({
      memberName: selectedMember.name,
      amount,
      phone: selectedMember.phone,
    });

    setPaymentAmount('');
    setPaymentDate(new Date());
    setSelectedMember(null);
    setIsPaymentOpen(false);
    setIsInvoiceDialogOpen(true);
  };

  // Removed: handleRenewal - now using MemberRenewalModal component

  const handlePayFull = () => {
    if (selectedMember) {
      setPaymentAmount(String(selectedMember.balance));
    }
  };

  const handleDownloadInvoice = async () => {
    if (!lastPaymentInfo || !profile) return;

    // Check free tier limit for invoices
    if (!freeTierLimits.canGenerateInvoice) {
      setUpgradeLimitType('invoices');
      setIsUpgradeOpen(true);
      return;
    }

    try {
      const invoiceNumber = getNextInvoiceNumber();

      await generateMemberInvoice(
        lastPaymentInfo.memberName,
        lastPaymentInfo.amount,
        profile.business_name,
        profile.tax_trn,
        profile.tax_rate || 5,
        profile.tax_name || 'VAT',
        invoiceNumber,
        profile.company_address,
        profile.company_logo_url
      );

      // Increment invoice number for next time
      await incrementInvoiceNumber.mutateAsync();

      toast.success('Invoice downloaded!');
    } catch (error) {
      toast.error('Failed to generate invoice');
      console.error(error);
    }
  };

  const handleShareWhatsApp = () => {
    if (!lastPaymentInfo || !profile) return;

    const taxRate = profile.tax_rate || 5;
    const taxName = profile.tax_name || 'VAT';
    const subtotal = lastPaymentInfo.amount / (1 + taxRate / 100);
    const taxAmount = lastPaymentInfo.amount - subtotal;

    const message = `ðŸ§¾ *Payment Receipt*

*${profile.business_name}*
${profile.tax_trn ? `TRN: ${profile.tax_trn}` : ''}

Dear ${lastPaymentInfo.memberName},

Thank you for your payment!

Subscription: AED ${subtotal.toFixed(2)}
${taxName} (${taxRate}%): AED ${taxAmount.toFixed(2)}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
*Total Paid: AED ${lastPaymentInfo.amount.toFixed(2)}*

Date: ${formatDate(new Date())}

Thank you for your business! ðŸ™`;

    const cleanPhone = lastPaymentInfo.phone.replace(/[\s-]/g, '');
    const phoneWithCode = cleanPhone.startsWith('+') ? cleanPhone.slice(1) :
      cleanPhone.startsWith('00') ? cleanPhone.slice(2) :
        cleanPhone.startsWith('971') ? cleanPhone :
          `971${cleanPhone.startsWith('0') ? cleanPhone.slice(1) : cleanPhone}`;

    const whatsappUrl = `https://wa.me/${phoneWithCode}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    toast.success('Opening WhatsApp...');
  };

  const handleShareWhatsAppPDF = async () => {
    if (!lastPaymentInfo || !profile) return;

    // Check free tier limit for invoices
    if (!freeTierLimits.canGenerateInvoice) {
      setUpgradeLimitType('invoices');
      setIsUpgradeOpen(true);
      return;
    }

    try {
      const invoiceNumber = getNextInvoiceNumber();

      await shareInvoiceViaWhatsApp(
        lastPaymentInfo.memberName,
        lastPaymentInfo.phone,
        lastPaymentInfo.amount,
        profile.business_name,
        invoiceNumber,
        profile.tax_trn,
        profile.tax_rate || 5,
        profile.tax_name || 'VAT',
        profile.company_address
      );

      // Increment invoice number for next time
      await incrementInvoiceNumber.mutateAsync();

      setIsInvoiceDialogOpen(false);
    } catch (error) {
      console.error('Failed to share PDF via WhatsApp:', error);
    }
  };

  const handleBulkReminder = () => {
    if (!profile) return;

    unpaidMembers.forEach((member, index) => {
      const message = `ðŸ“¢ *Payment Reminder*

*${profile.business_name}*

Dear ${member.name},

This is a friendly reminder that you have an outstanding balance of *AED ${Number(member.balance).toFixed(2)}*.

${member.plan_expiry_date ? `Due Date: ${formatDate(new Date(member.plan_expiry_date))}` : ''}

${profile.payment_link ? `Pay online: ${profile.payment_link}` : ''}

Thank you for your prompt attention! ðŸ™`;

      const cleanPhone = member.phone.replace(/[\s-]/g, '');
      const phoneWithCode = cleanPhone.startsWith('+') ? cleanPhone.slice(1) :
        cleanPhone.startsWith('00') ? cleanPhone.slice(2) :
          cleanPhone.startsWith('971') ? cleanPhone :
            `971${cleanPhone.startsWith('0') ? cleanPhone.slice(1) : cleanPhone}`;

      // Open WhatsApp links with delay to prevent browser blocking
      setTimeout(() => {
        const whatsappUrl = `https://wa.me/${phoneWithCode}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
      }, index * 500);
    });

    toast.success(`Opening WhatsApp for ${unpaidMembers.length} members...`);
    setIsBulkReminderOpen(false);
  };

  const handleSingleReminder = (member: typeof members[0]) => {
    if (!profile) return;

    const message = `ðŸ“¢ *Payment Reminder*

*${profile.business_name}*

Dear ${member.name},

This is a friendly reminder that you have an outstanding balance of *AED ${Number(member.balance).toFixed(2)}*.

${member.plan_expiry_date ? `Due Date: ${formatDate(new Date(member.plan_expiry_date))}` : ''}

${profile.payment_link ? `Pay online: ${profile.payment_link}` : ''}

Thank you for your prompt attention! ðŸ™`;

    const cleanPhone = member.phone.replace(/[\s-]/g, '');
    const phoneWithCode = cleanPhone.startsWith('+') ? cleanPhone.slice(1) :
      cleanPhone.startsWith('00') ? cleanPhone.slice(2) :
        cleanPhone.startsWith('971') ? cleanPhone :
          `971${cleanPhone.startsWith('0') ? cleanPhone.slice(1) : cleanPhone}`;

    const whatsappUrl = `https://wa.me/${phoneWithCode}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  };

  const openPayment = (member: typeof members[0]) => {
    setSelectedMember(member);
    setPaymentAmount('');
    setPaymentDate(new Date());
    setIsPaymentOpen(true);
  };

  const openRenewal = (member: typeof members[0]) => {
    setSelectedMember(member);
    setIsSmartRenewalOpen(true);
  };

  const openHistory = (member: typeof members[0]) => {
    setSelectedMember(member);
    setIsHistoryOpen(true);
  };

  const openEdit = (member: typeof members[0]) => {
    setSelectedMember(member);
    setEditFormData({
      name: member.name,
      phone: member.phone,
      plan_type: member.plan_type,
      monthly_fee: String(member.monthly_fee),
      status: member.status,
      joining_date: member.joining_date ? new Date(member.joining_date) : null,
      plan_expiry_date: member.plan_expiry_date ? new Date(member.plan_expiry_date) : null,
    });
    setIsEditOpen(true);
  };

  const handleEditMember = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!selectedMember) return;

    await updateMember.mutateAsync({
      id: selectedMember.id,
      name: editFormData.name.trim(),
      phone: editFormData.phone.trim(),
      plan_type: editFormData.plan_type,
      monthly_fee: Number(editFormData.monthly_fee),
      status: editFormData.status,
      joining_date: editFormData.joining_date?.toISOString(),
      plan_expiry_date: editFormData.plan_expiry_date?.toISOString(),
    });

    setIsEditOpen(false);
    setSelectedMember(null);
  };

  const getMemberExpiryStatus = (member: typeof members[0]) => {
    if (!member.plan_expiry_date) return null;
    const days = getDaysUntilExpiry(member.plan_expiry_date);
    if (days < 0) return { status: 'expired', days: Math.abs(days) };
    if (days <= 4) return { status: 'expiring', days };
    return null;
  };

  const handleDelete = async () => {
    if (!deleteId) return;
    await deleteMember.mutateAsync(deleteId);
    setDeleteId(null);
  };

  const getRemainingAfterPayment = () => {
    if (!selectedMember) return 0;
    const amount = Number(paymentAmount) || 0;
    return Math.max(0, Number(selectedMember.balance) - amount);
  };

  const getTransactionTypeLabel = (type: string) => {
    switch (type) {
      case 'payment': return { label: 'Payment', color: 'text-primary' };
      case 'charge': return { label: 'Charge', color: 'text-destructive' };
      case 'adjustment': return { label: 'Adjustment', color: 'text-muted-foreground' };
      default: return { label: type, color: 'text-foreground' };
    }
  };

  return (
    <AppLayout>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">Members</h1>
            <p className="text-muted-foreground">{filteredMembers.length} of {members.length} members</p>
          </div>

          <div className="flex gap-2">
            {unpaidMembers.length > 0 && (
              <Button
                variant="outline"
                size="sm"
                onClick={() => setIsBulkReminderOpen(true)}
              >
                <Send className="h-4 w-4 mr-1" />
                Remind ({unpaidMembers.length})
              </Button>
            )}

            <Button
              variant="outline"
              size="sm"
              onClick={() => setIsImportOpen(true)}
            >
              <Upload className="h-4 w-4 mr-1" />
              Import
            </Button>

            <Dialog open={isAddOpen} onOpenChange={setIsAddOpen}>
              <DialogTrigger asChild>
                <Button size="sm">
                  <Plus className="h-4 w-4 mr-1" />
                  Add
                </Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>Add New Member</DialogTitle>
                </DialogHeader>
                <form onSubmit={handleAddMember} className="space-y-4">
                  <div className="space-y-2">
                    <Label htmlFor="name">Name</Label>
                    <Input
                      id="name"
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      placeholder="John Doe"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="phone">Phone</Label>
                    <Input
                      id="phone"
                      value={formData.phone}
                      onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                      placeholder="05X XXX XXXX"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="joining_date">Joining Date</Label>
                    <Input
                      id="joining_date"
                      type="date"
                      value={formData.joining_date}
                      onChange={(e) => setFormData({ ...formData, joining_date: e.target.value })}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="plan">Meal Plan</Label>
                    <Select
                      value={formData.plan_type}
                      onValueChange={(value: PlanType) => setFormData({ ...formData, plan_type: value })}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="1-time">1 Time</SelectItem>
                        <SelectItem value="2-time">2 Times</SelectItem>
                        <SelectItem value="3-time">3 Times</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="fee">Monthly Fee (AED)</Label>
                    <Input
                      id="fee"
                      type="number"
                      value={formData.monthly_fee}
                      onChange={(e) => setFormData({ ...formData, monthly_fee: e.target.value })}
                      placeholder="1500"
                      required
                    />
                  </div>

                  <div className="flex items-center justify-between p-4 rounded-lg border bg-muted/30">
                    <div className="space-y-0.5">
                      <Label htmlFor="paid-toggle" className="text-base">Payment Status</Label>
                      <p className="text-sm text-muted-foreground">
                        {formData.isPaid ? 'First month paid' : 'First month unpaid'}
                      </p>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className={`text-sm ${!formData.isPaid ? 'text-destructive font-medium' : 'text-muted-foreground'}`}>
                        Unpaid
                      </span>
                      <Switch
                        id="paid-toggle"
                        checked={formData.isPaid}
                        onCheckedChange={(checked) => setFormData({ ...formData, isPaid: checked })}
                      />
                      <span className={`text-sm ${formData.isPaid ? 'text-primary font-medium' : 'text-muted-foreground'}`}>
                        Paid
                      </span>
                    </div>
                  </div>

                  <Button type="submit" className="w-full" disabled={addMember.isPending}>
                    {addMember.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                    Add Member
                  </Button>
                </form>
              </DialogContent>
            </Dialog>
          </div>
        </div>

        {/* Search and Filter Bar */}
        <div className="space-y-3">
          <div className="flex gap-2">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Search by name or phone..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-9"
              />
              {searchQuery && (
                <Button
                  variant="ghost"
                  size="icon"
                  className="absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7"
                  onClick={() => setSearchQuery('')}
                >
                  <X className="h-3 w-3" />
                </Button>
              )}
            </div>
            <Button
              variant={showFilters || hasActiveFilters ? 'secondary' : 'outline'}
              size="icon"
              onClick={() => setShowFilters(!showFilters)}
              className="relative"
            >
              <Filter className="h-4 w-4" />
              {hasActiveFilters && (
                <span className="absolute -top-1 -right-1 h-3 w-3 bg-primary rounded-full" />
              )}
            </Button>
          </div>

          {showFilters && (
            <div className="flex flex-wrap gap-2 p-3 rounded-lg border bg-muted/30">
              <Select
                value={statusFilter}
                onValueChange={(value) => setStatusFilter(value as MemberStatus | 'all')}
              >
                <SelectTrigger className="w-32">
                  <SelectValue placeholder="Status" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Status</SelectItem>
                  <SelectItem value="active">Active</SelectItem>
                  <SelectItem value="inactive">Inactive</SelectItem>
                </SelectContent>
              </Select>

              <Select
                value={planFilter}
                onValueChange={(value) => setPlanFilter(value as PlanType | 'all')}
              >
                <SelectTrigger className="w-32">
                  <SelectValue placeholder="Plan" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Plans</SelectItem>
                  <SelectItem value="1-time">1 Time</SelectItem>
                  <SelectItem value="2-time">2 Times</SelectItem>
                  <SelectItem value="3-time">3 Times</SelectItem>
                </SelectContent>
              </Select>

              {hasActiveFilters && (
                <Button variant="ghost" size="sm" onClick={clearFilters}>
                  <X className="h-3 w-3 mr-1" />
                  Clear
                </Button>
              )}
            </div>
          )}
        </div>

        <div className="space-y-3">
          {isLoading ? (
            Array.from({ length: 5 }).map((_, i) => (
              <Skeleton key={i} className="h-24 w-full" />
            ))
          ) : filteredMembers.length === 0 ? (
            <Card>
              <CardContent className="py-8 text-center text-muted-foreground">
                {members.length === 0
                  ? 'No members yet. Add your first member to get started.'
                  : 'No members match your search or filters.'}
              </CardContent>
            </Card>
          ) : (
            filteredMembers.map((member) => {
              const expiryStatus = getMemberExpiryStatus(member);
              const isPaid = Number(member.balance) === 0;
              const isExpiredOrExpiring = expiryStatus?.status === 'expired' || expiryStatus?.status === 'expiring';

              return (
                <Card
                  key={member.id}
                  className={`overflow-hidden ${expiryStatus?.status === 'expiring' ? 'border-amber-500' : expiryStatus?.status === 'expired' ? 'border-destructive' : ''}`}
                >
                  <CardContent className="p-4">
                    <div className="flex items-start justify-between">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 flex-wrap">
                          <h3 className="font-medium truncate">{member.name}</h3>
                          <Badge variant={member.status === 'active' ? 'default' : 'secondary'}>
                            {member.status}
                          </Badge>
                          <Badge variant={isPaid ? 'outline' : 'destructive'} className={isPaid ? 'border-primary text-primary' : ''}>
                            {isPaid ? 'Paid' : 'Unpaid'}
                          </Badge>
                          {expiryStatus && (
                            <Badge
                              variant="outline"
                              className={expiryStatus.status === 'expiring' ? 'border-amber-500 text-amber-500' : 'border-destructive text-destructive'}
                            >
                              <AlertTriangle className="h-3 w-3 mr-1" />
                              {expiryStatus.status === 'expired'
                                ? `Expired ${expiryStatus.days}d ago`
                                : `Expires in ${expiryStatus.days}d`
                              }
                            </Badge>
                          )}
                        </div>
                        <div className="flex items-center gap-4 mt-1 text-sm text-muted-foreground flex-wrap">
                          <span className="flex items-center gap-1">
                            <Phone className="h-3 w-3" />
                            {member.phone}
                          </span>
                          <span>{member.plan_type}</span>
                          <span className="flex items-center gap-1">
                            <UserPlus className="h-3 w-3" />
                            Joined: {formatDate(new Date(member.joining_date))}
                          </span>
                        </div>
                        <div className="flex items-center gap-4 mt-1 text-xs text-muted-foreground flex-wrap">
                          {member.plan_expiry_date && (
                            <span>
                              Expires: {formatDate(new Date(member.plan_expiry_date))}
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="text-right flex flex-col items-end gap-2">
                        <div>
                          <p className="text-sm text-muted-foreground">Balance</p>
                          <p className={`font-semibold ${Number(member.balance) > 0 ? 'text-destructive' : 'text-foreground'}`}>
                            {formatCurrency(Number(member.balance))}
                          </p>
                        </div>
                        <div className="flex gap-1 flex-wrap justify-end">
                          {Number(member.balance) > 0 && (
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => openPayment(member)}
                            >
                              <CreditCard className="h-3 w-3 mr-1" />
                              Pay
                            </Button>
                          )}
                          {isExpiredOrExpiring && (
                            <Button
                              size="sm"
                              variant="outline"
                              className="border-primary text-primary hover:bg-primary/10"
                              onClick={() => openRenewal(member)}
                            >
                              <RefreshCw className="h-3 w-3 mr-1" />
                              Renew
                            </Button>
                          )}
                          {Number(member.balance) > 0 && (
                            <Button
                              size="sm"
                              variant="outline"
                              className="border-amber-500 text-amber-600 hover:bg-amber-500/10"
                              onClick={() => handleSingleReminder(member)}
                              title="Send WhatsApp Reminder"
                            >
                              <MessageCircle className="h-3 w-3 mr-1" />
                              Remind
                            </Button>
                          )}
                          <Button
                            size="icon"
                            variant="ghost"
                            className="h-8 w-8"
                            onClick={() => openEdit(member)}
                            title="Edit member"
                          >
                            <Pencil className="h-4 w-4" />
                          </Button>
                          <Button
                            size="icon"
                            variant="ghost"
                            className="h-8 w-8"
                            onClick={() => openHistory(member)}
                            title="Transaction history"
                          >
                            <History className="h-4 w-4" />
                          </Button>
                          <Button
                            size="icon"
                            variant="ghost"
                            className="h-8 w-8 text-destructive hover:text-destructive"
                            onClick={() => setDeleteId(member.id)}
                            title="Delete member"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              );
            })
          )}
        </div>

        {/* Payment Dialog */}
        <Dialog open={isPaymentOpen} onOpenChange={setIsPaymentOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Record Payment</DialogTitle>
            </DialogHeader>
            {selectedMember && (
              <form onSubmit={handlePayment} className="space-y-4">
                <div className="p-4 rounded-lg bg-muted/50 space-y-2">
                  <p className="font-medium">{selectedMember.name}</p>
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-muted-foreground">Outstanding Balance:</span>
                    <span className="font-semibold text-destructive">
                      {formatCurrency(Number(selectedMember.balance))}
                    </span>
                  </div>
                  {selectedMember.plan_expiry_date && (
                    <div className="flex items-center justify-between text-sm">
                      <span className="text-muted-foreground flex items-center gap-1">
                        <CalendarIcon className="h-3 w-3" />
                        Due Date:
                      </span>
                      <span className="font-medium">
                        {formatDate(new Date(selectedMember.plan_expiry_date))}
                      </span>
                    </div>
                  )}
                </div>

                <div className="flex gap-2">
                  <Button
                    type="button"
                    variant="outline"
                    className="flex-1"
                    onClick={handlePayFull}
                  >
                    Pay Full Amount
                  </Button>
                </div>

                <div className="space-y-2">
                  <Label>Payment Date</Label>
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => setShowPaymentCalendar(!showPaymentCalendar)}
                    className={cn(
                      "w-full justify-start text-left font-normal",
                      !paymentDate && "text-muted-foreground"
                    )}
                  >
                    <CalendarIcon className="mr-2 h-4 w-4" />
                    {paymentDate ? format(paymentDate, "PPP") : "Pick a date"}
                  </Button>
                  {showPaymentCalendar && (
                    <div className="rounded-md border bg-background p-0 shadow-sm">
                      <Calendar
                        mode="single"
                        selected={paymentDate || undefined}
                        onSelect={(date) => {
                          setPaymentDate(date || null);
                          setShowPaymentCalendar(false);
                        }}
                        initialFocus
                        className="p-3"
                      />
                    </div>
                  )}
                </div>

                <div className="space-y-2">
                  <Label htmlFor="amount">Or Enter Custom Amount (AED)</Label>
                  <Input
                    id="amount"
                    type="number"
                    value={paymentAmount}
                    onChange={(e) => setPaymentAmount(e.target.value)}
                    placeholder="Enter amount"
                    max={Number(selectedMember.balance)}
                    required
                  />
                </div>

                {paymentAmount && Number(paymentAmount) > 0 && (
                  <div className="p-3 rounded-lg border bg-muted/30">
                    <div className="flex items-center justify-between text-sm">
                      <span className="text-muted-foreground">After this payment:</span>
                      <span className={`font-semibold ${getRemainingAfterPayment() > 0 ? 'text-destructive' : 'text-primary'}`}>
                        {getRemainingAfterPayment() > 0
                          ? `${formatCurrency(getRemainingAfterPayment())} remaining`
                          : 'Fully Paid âœ“'
                        }
                      </span>
                    </div>
                  </div>
                )}

                <Button type="submit" className="w-full" disabled={addTransaction.isPending}>
                  {addTransaction.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                  Record Payment
                </Button>
              </form>
            )}
          </DialogContent>
        </Dialog>

        {/* Edit Member Dialog */}
        <Dialog open={isEditOpen} onOpenChange={setIsEditOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Edit Member</DialogTitle>
            </DialogHeader>
            <form onSubmit={handleEditMember} className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="edit-name">Name</Label>
                <Input
                  id="edit-name"
                  value={editFormData.name}
                  onChange={(e) => setEditFormData({ ...editFormData, name: e.target.value })}
                  placeholder="John Doe"
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-phone">Phone</Label>
                <Input
                  id="edit-phone"
                  value={editFormData.phone}
                  onChange={(e) => setEditFormData({ ...editFormData, phone: e.target.value })}
                  placeholder="05X XXX XXXX"
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-plan">Meal Plan</Label>
                <Select
                  value={editFormData.plan_type}
                  onValueChange={(value: PlanType) => setEditFormData({ ...editFormData, plan_type: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="1-time">1 Time</SelectItem>
                    <SelectItem value="2-time">2 Times</SelectItem>
                    <SelectItem value="3-time">3 Times</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-fee">Monthly Fee (AED)</Label>
                <Input
                  id="edit-fee"
                  type="number"
                  value={editFormData.monthly_fee}
                  onChange={(e) => setEditFormData({ ...editFormData, monthly_fee: e.target.value })}
                  placeholder="1500"
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-status">Status</Label>
                <Select
                  value={editFormData.status}
                  onValueChange={(value: MemberStatus) => setEditFormData({ ...editFormData, status: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="inactive">Inactive</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Joining Date</Label>
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => setShowJoiningCalendar(!showJoiningCalendar)}
                    className={cn(
                      "w-full justify-start text-left font-normal",
                      !editFormData.joining_date && "text-muted-foreground"
                    )}
                  >
                    <CalendarIcon className="mr-2 h-4 w-4" />
                    {editFormData.joining_date ? format(editFormData.joining_date, "PPP") : "Pick a date"}
                  </Button>
                  {showJoiningCalendar && (
                    <div className="rounded-md border bg-background p-0 shadow-sm">
                      <Calendar
                        mode="single"
                        selected={editFormData.joining_date || undefined}
                        onSelect={(date) => {
                          setEditFormData({ ...editFormData, joining_date: date || null });
                          setShowJoiningCalendar(false);
                        }}
                        initialFocus
                        className="p-3"
                      />
                    </div>
                  )}
                </div>
                <div className="space-y-2">
                  <Label>Subscription Expiry</Label>
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => setShowExpiryCalendar(!showExpiryCalendar)}
                    className={cn(
                      "w-full justify-start text-left font-normal",
                      !editFormData.plan_expiry_date && "text-muted-foreground"
                    )}
                  >
                    <CalendarIcon className="mr-2 h-4 w-4" />
                    {editFormData.plan_expiry_date ? format(editFormData.plan_expiry_date, "PPP") : "Pick a date"}
                  </Button>
                  {showExpiryCalendar && (
                    <div className="rounded-md border bg-background p-0 shadow-sm">
                      <Calendar
                        mode="single"
                        selected={editFormData.plan_expiry_date || undefined}
                        onSelect={(date) => {
                          setEditFormData({ ...editFormData, plan_expiry_date: date || null });
                          setShowExpiryCalendar(false);
                        }}
                        initialFocus
                        className="p-3"
                      />
                    </div>
                  )}
                </div>
              </div>
              <Button type="submit" className="w-full" disabled={updateMember.isPending}>
                {updateMember.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Save Changes
              </Button>
            </form>
          </DialogContent>
        </Dialog>

        {/* Smart Renewal Modal */}
        <MemberRenewalModal
          open={isSmartRenewalOpen}
          onOpenChange={setIsSmartRenewalOpen}
          member={selectedMember ? {
            id: selectedMember.id,
            name: selectedMember.name,
            monthly_fee: Number(selectedMember.monthly_fee),
            plan_expiry_date: selectedMember.plan_expiry_date,
          } : null}
        />

        {/* History Dialog */}
        <TransactionHistoryModal
          open={isHistoryOpen}
          onOpenChange={setIsHistoryOpen}
          member={selectedMember ? {
            id: selectedMember.id,
            name: selectedMember.name,
            balance: Number(selectedMember.balance),
            phone: selectedMember.phone,
          } : null}
        />

        {/* Bulk Reminder Dialog */}
        <AlertDialog open={isBulkReminderOpen} onOpenChange={setIsBulkReminderOpen}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Send Payment Reminders</AlertDialogTitle>
              <AlertDialogDescription>
                This will open WhatsApp for {unpaidMembers.length} members with outstanding balances.
                Each reminder will include their name, balance amount, and due date.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <div className="max-h-[200px] overflow-y-auto space-y-2 my-4">
              {unpaidMembers.map((member) => (
                <div key={member.id} className="flex items-center justify-between p-2 rounded bg-muted/50 text-sm">
                  <span>{member.name}</span>
                  <span className="text-destructive font-medium">{formatCurrency(Number(member.balance))}</span>
                </div>
              ))}
            </div>
            <AlertDialogFooter>
              <AlertDialogCancel>Cancel</AlertDialogCancel>
              <AlertDialogAction onClick={handleBulkReminder}>
                <MessageCircle className="h-4 w-4 mr-2" />
                Send Reminders
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* Invoice Actions Dialog */}
        <Dialog open={isInvoiceDialogOpen} onOpenChange={setIsInvoiceDialogOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Invoice Ready! ðŸŽ‰</DialogTitle>
            </DialogHeader>
            {lastPaymentInfo && (
              <div className="space-y-4">
                <p className="text-muted-foreground">
                  Invoice for <strong>{formatCurrency(lastPaymentInfo.amount)}</strong> created for <strong>{lastPaymentInfo.memberName}</strong>.
                </p>
                <p className="text-sm text-muted-foreground">
                  What would you like to do?
                </p>
                <div className="grid gap-3">
                  <Button
                    variant="outline"
                    className="w-full justify-start"
                    onClick={handleDownloadInvoice}
                  >
                    <FileText className="h-4 w-4 mr-2" />
                    Download Invoice (PDF)
                  </Button>
                  <Button
                    variant="outline"
                    className="w-full justify-start text-primary hover:text-primary/80 hover:bg-primary/10"
                    onClick={handleShareWhatsAppPDF}
                  >
                    <Share2 className="h-4 w-4 mr-2" />
                    Share PDF via WhatsApp
                  </Button>
                  <Button
                    variant="ghost"
                    className="w-full justify-start text-muted-foreground"
                    onClick={handleShareWhatsApp}
                  >
                    <MessageCircle className="h-4 w-4 mr-2" />
                    Share Text Message
                  </Button>
                </div>
              </div>
            )}
            <DialogFooter>
              <Button variant="ghost" onClick={() => setIsInvoiceDialogOpen(false)}>
                Close
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* Delete Confirmation */}
        <AlertDialog open={!!deleteId} onOpenChange={() => setDeleteId(null)}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Delete Member?</AlertDialogTitle>
              <AlertDialogDescription>
                This action cannot be undone. The member and their transaction history will be permanently deleted.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>Cancel</AlertDialogCancel>
              <AlertDialogAction onClick={handleDelete} className="bg-destructive text-destructive-foreground hover:bg-destructive/90">
                Delete
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* Upgrade Plan Modal */}
        <UpgradePlanModal
          open={isUpgradeOpen}
          onOpenChange={setIsUpgradeOpen}
          limitType={upgradeLimitType}
          currentCount={
            upgradeLimitType === 'members' ? freeTierLimits.memberCount :
              upgradeLimitType === 'invoices' ? freeTierLimits.invoiceCount :
                freeTierLimits.receiptCount
          }
          limit={
            upgradeLimitType === 'members' ? freeTierLimits.memberLimit :
              upgradeLimitType === 'invoices' ? freeTierLimits.invoiceLimit :
                freeTierLimits.receiptLimit
          }
        />

        {/* Member Import Modal */}
        <MemberImportModal
          open={isImportOpen}
          onOpenChange={setIsImportOpen}
          memberLimit={freeTierLimits.memberLimit}
          currentMemberCount={freeTierLimits.memberCount}
        />
      </div>
    </AppLayout>
  );
}
